---
- name: "ğŸš€ MEGA IMPORT: Sites, Hardware og AP'er i Ã©t hug!"
  hosts: localhost
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"
    # Stien til din fil med de 2000 AP'er pÃ¥ CC serveren
    ap_file: "/tmp/aruba_aps.json" 

  tasks:
    - name: "1. LÃ¦s den lokale JSON-fil ğŸ“‚"
      set_fact:
        aruba_data: "{{ lookup('file', ap_file) | from_json }}"

    - name: "2. Opret 'Aruba' som Manufacturer og 'Access Point' som Rolle ğŸ—ï¸"
      block:
        - netbox.netbox.netbox_manufacturer:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Aruba", slug: "aruba" }
            state: present
        
        - netbox.netbox.netbox_device_role:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Access Point", slug: "access-point", color: "9c27b0" }
            state: present

    - name: "3. Opret automatisk ALLE Sites baseret pÃ¥ AP-navne (f.eks. SEB) ğŸŒ"
      netbox.netbox.netbox_site:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # Klipper alt fÃ¸r fÃ¸rste bindestreg (SEB-Aruba-AP01 -> SEB)
          name: "{{ item.Name.split('-')[0] | upper }}"
          slug: "{{ item.Name.split('-')[0] | lower }}"
          status: "active"
        state: present
      loop: "{{ aruba_data }}"
      loop_control:
        label: "Sikrer at site findes: {{ item.Name.split('-')[0] | upper }}"

    - name: "4. Opret MANGLENDE Hardware Modeller (f.eks. AP-305) ğŸ·ï¸"
      netbox.netbox.netbox_device_type:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          manufacturer: "Aruba"
          # SÃ¦tter "AP-" foran nummeret, sÃ¥ det ser rigtigt ud i NetBox
          model: "AP-{{ item['AP Type'] }}"
          slug: "ap-{{ item['AP Type'] | lower }}"
        state: present
      loop: "{{ aruba_data }}"
      loop_control:
        label: "Sikrer at model findes: AP-{{ item['AP Type'] }}"

    - name: "5. Opret selve AP'erne i NetBox! ğŸ“¡ğŸ’¥"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ item.Name }}"
          device_type: "AP-{{ item['AP Type'] }}"
          device_role: "Access Point"
          # Placerer den pÃ¥ det site, vi klippede ud tidligere
          site: "{{ item.Name.split('-')[0] | lower }}"
          status: "active"
        state: present
      loop: "{{ aruba_data }}"
      loop_control:
        label: "Opretter/Opdaterer: {{ item.Name }}"
