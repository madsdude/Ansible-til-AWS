---
# PLAY 1: Forbered FortiGate IP'en
- name: "Forbered FortiGate IP"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "TilfÃ¸j firewall IP til midlertidig gruppe"
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: discovered_firewalls
        # HER ER FIXET: FortÃ¦l Ansible at den skal kÃ¸re web-kaldet lokalt
        ansible_connection: local
      loop: "{{ target_ips.split(',') }}"
      when: target_ips is defined

# PLAY 2: REST API Discovery & NetBox Onboarding
- name: "FortiGate HA Onboarding (REST API)"
  hosts: discovered_firewalls
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"
    fortigate_token: "{{ lookup('ansible.builtin.env', 'FORTIGATE_API_TOKEN') }}"

  tasks:
    - name: "1. Hent System Status fra FortiGate (Master) ğŸ•µï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/status"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_status

    - name: "1b. Udled Site fra Firewallens navn (TST-FW01 -> TST) ğŸ§ "
      set_fact:
        fw_site: "{{ fg_status.json.results.hostname.split('-')[0] | upper }}"
      when: fg_status.json.results.hostname is defined

    - name: "2. Hent HA Status (Cluster Info) ğŸ‘¯â€â™‚ï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/ha"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_ha
      ignore_errors: yes

    - name: "3. Hent alle Interfaces & IP'er (CMDB Configuration) ğŸ”Œ"
      ansible.builtin.uri:
        # HER ER FIXET: Vi kigger nu i CMDB i stedet for Monitor for at se byggetegningen
        url: "https://{{ inventory_hostname }}/api/v2/cmdb/system/interface"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_interfaces_cmdb

    - name: "4. Opret Basis OpsÃ¦tning i NetBox (Fortinet & Firewall)"
      block:
        - netbox.netbox.netbox_manufacturer:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Fortinet", slug: "fortinet" }
        - netbox.netbox.netbox_device_role:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Firewall", color: "ff9800" }
        - netbox.netbox.netbox_device_type:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data:
              manufacturer: "Fortinet"
              model: "FortiGate HA Cluster"
              slug: "fortigate-ha-cluster"
      delegate_to: localhost
      run_once: true

    - name: "5. Opret den Aktive FortiGate (Master) i NetBox ğŸ†"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          device_type: "FortiGate HA Cluster"
          device_role: "Firewall"
          site: "{{ fw_site | default(target_site) }}" 
          serial: "{{ fg_status.json.results.serial | default('') }}"
          status: "active"
      delegate_to: localhost

    - name: "6a. SYNC Fysiske & Aggregate Interfaces (ForÃ¦ldre) ğŸ”Œ"
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          name: "{{ item.name }}"
          # Dynamisk type: Hvis Aggregate -> lag. Ellers fysisk.
          type: "{{ 'lag' if item.type == 'aggregate' else '1000base-t' }}"
          enabled: "{{ item.status == 'up' }}"
          mac_address: "{{ item.mac | default(omit) }}"
      # CMDB returnerer en ren liste, sÃ¥ vi behÃ¸ver ikke dict2items mere
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      # Vi tager IKKE VLANs med i denne runde
      when: 
        - item.name is defined
        - item.type != 'vlan'
      delegate_to: localhost
      ignore_errors: yes

    - name: "6b. SYNC VLAN Sub-interfaces (BÃ¸rnene) ğŸ‘¨â€ğŸ‘¦"
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          name: "{{ item.name }}"
          type: "virtual"
          enabled: "{{ item.status == 'up' }}"
          # Her bygger vi stamtrÃ¦et! Vi binder den til dens fysiske/aggregate port
          parent_interface: "{{ item.interface }}"
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      # Nu tager vi KUN Vlans, og tjekker at de har en forÃ¦lder
      when: 
        - item.name is defined
        - item.type == 'vlan'
        - item.interface is defined
      delegate_to: localhost
      ignore_errors: yes

    - name: "7. SYNC IP Adresser (Gateways) ğŸŒ"
      netbox.netbox.netbox_ip_address:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # CMDB returnerer IP som "10.0.50.76 255.255.255.248". Vi bytter mellemrum til "/" og regner CIDR.
          address: "{{ item.ip | replace(' ', '/') | ipaddr('host/prefix') }}"
          status: "active"
          assigned_object:
            device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
            name: "{{ item.name }}"
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      when: 
        - item.ip is defined
        - "'0.0.0.0' not in item.ip"
        - "item.ip != ''"
      delegate_to: localhost
      ignore_errors: yes
