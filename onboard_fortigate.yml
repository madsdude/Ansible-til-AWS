---
# PLAY 1: Forbered FortiGate IP'en
- name: "Forbered FortiGate IP"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "TilfÃ¸j firewall IP til midlertidig gruppe"
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: discovered_firewalls
        # HER ER FIXET: FortÃ¦l Ansible at den skal kÃ¸re web-kaldet lokalt
        ansible_connection: local
      loop: "{{ target_ips.split(',') }}"
      when: target_ips is defined

# PLAY 2: REST API Discovery & NetBox Onboarding
- name: "FortiGate HA Onboarding (REST API)"
  hosts: discovered_firewalls
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"
    fortigate_token: "{{ lookup('ansible.builtin.env', 'FORTIGATE_API_TOKEN') }}"

  tasks:
    - name: "1. Hent System Status fra FortiGate (Master) ğŸ•µï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/status"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_status

    - name: "1b. Udled Site fra Firewallens navn (TST-FW01 -> TST) ğŸ§ "
      set_fact:
        fw_site: "{{ fg_status.json.results.hostname.split('-')[0] | upper }}"
      when: fg_status.json.results.hostname is defined

    - name: "2. Hent HA Status (Cluster Info) ğŸ‘¯â€â™‚ï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/ha"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_ha
      ignore_errors: yes

    - name: "3. Hent alle Interfaces & IP'er ğŸ”Œ"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/interface"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_interfaces

    - name: "4. Opret Basis OpsÃ¦tning i NetBox (Fortinet & Firewall)"
      block:
        - netbox.netbox.netbox_manufacturer:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Fortinet", slug: "fortinet" }
        - netbox.netbox.netbox_device_role:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Firewall", color: "ff9800" }
        - netbox.netbox.netbox_device_type:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data:
              manufacturer: "Fortinet"
              model: "FortiGate HA Cluster"
              slug: "fortigate-ha-cluster"
      delegate_to: localhost
      run_once: true

    - name: "5. Opret den Aktive FortiGate (Master) i NetBox ğŸ†"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          device_type: "FortiGate HA Cluster"
          device_role: "Firewall"
          site: "{{ fw_site | default(target_site) }}" 
          serial: "{{ fg_status.json.results.serial | default('') }}"
          status: "active"
      delegate_to: localhost

    - name: "6. SYNC Interfaces til Firewallen ğŸ”Œ"
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          name: "{{ item.value.name }}"
          type: "1000base-t"
          # API'et bruger 'link' (True/False) i stedet for 'status' pÃ¥ denne version
          enabled: "{{ item.value.link | default(true) | bool }}"
          mac_address: "{{ item.value.mac | default(omit) }}"
      # HER ER FIXET: dict2items konverterer ordbogen til en liste
      loop: "{{ fg_interfaces.json.results | dict2items }}"
      when: item.value.name is defined
      delegate_to: localhost
      ignore_errors: yes

    - name: "7. SYNC IP Adresser (Gateways) ğŸŒ"
      netbox.netbox.netbox_ip_address:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # Vi bruger item.value i stedet for item
          address: "{{ item.value.ip }}/{{ item.value.mask | default('255.255.255.0') | ipaddr('prefix') | default('24') }}"
          status: "active"
          assigned_object:
            device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
            name: "{{ item.value.name }}"
      loop: "{{ fg_interfaces.json.results | dict2items }}"
      when: 
        - item.value.ip is defined
        - item.value.ip != "0.0.0.0"
        - item.value.ip != ""
      delegate_to: localhost
      ignore_errors: yes
