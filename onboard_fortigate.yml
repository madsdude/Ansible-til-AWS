---
# PLAY 1: Forbered FortiGate IP'en
- name: "Forbered FortiGate IP"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "TilfÃ¸j firewall IP til midlertidig gruppe"
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: discovered_firewalls
        # HER ER FIXET: FortÃ¦l Ansible at den skal kÃ¸re web-kaldet lokalt
        ansible_connection: local
      loop: "{{ target_ips.split(',') }}"
      when: target_ips is defined

# PLAY 2: REST API Discovery & NetBox Onboarding
- name: "FortiGate HA Onboarding (REST API)"
  hosts: discovered_firewalls
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"
    fortigate_token: "{{ lookup('ansible.builtin.env', 'FORTIGATE_API_TOKEN') }}"

  tasks:
    - name: "1. Hent System Status fra FortiGate (Master) ðŸ•µï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/status"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_status

    - name: "1b. Udled Site fra Firewallens navn (TST-FW01 -> TST) ðŸ§ "
      set_fact:
        fw_site: "{{ fg_status.json.results.hostname.split('-')[0] | upper }}"
      when: fg_status.json.results.hostname is defined

    - name: "2. Hent HA Status (Cluster Info) ðŸ‘¯â€â™‚ï¸"
      ansible.builtin.uri:
        url: "https://{{ inventory_hostname }}/api/v2/monitor/system/ha"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
        # MAGIEN: Vi fortÃ¦ller Ansible at bÃ¥de 200 (OK) og 404 (Standalone) er succeskriterier!
        status_code: [200, 404]
      register: fg_ha

    - name: "3. Hent alle Interfaces & IP'er (CMDB Configuration) ðŸ”Œ"
      ansible.builtin.uri:
        # HER ER FIXET: Vi kigger nu i CMDB i stedet for Monitor for at se byggetegningen
        url: "https://{{ inventory_hostname }}/api/v2/cmdb/system/interface"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: no
        return_content: yes
      register: fg_interfaces_cmdb

    - name: "4. Opret Basis OpsÃ¦tning i NetBox (Fortinet & Firewall)"
      block:
        - netbox.netbox.netbox_manufacturer:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Fortinet", slug: "fortinet" }
        - netbox.netbox.netbox_device_role:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Firewall", color: "ff9800" }
        - netbox.netbox.netbox_device_type:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data:
              manufacturer: "Fortinet"
              model: "FortiGate HA Cluster"
              slug: "fortigate-ha-cluster"
      delegate_to: localhost
      run_once: true

    - name: "5. Opret den Aktive FortiGate (Master) i NetBox ðŸ†"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          device_type: "FortiGate HA Cluster"
          device_role: "Firewall"
          site: "{{ fw_site | default(target_site) }}" 
          serial: "{{ fg_status.json.results.serial | default('') }}"
          status: "active"
      delegate_to: localhost

    - name: "5b. Opret Virtual Chassis (HA Cluster) i NetBox ðŸ”—"
      netbox.netbox.netbox_virtual_chassis:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "HA-{{ fw_site | default('SITE') }}"
      # Denne (og de nÃ¦ste) kÃ¸rer KUN, hvis firewallen returnerede 200 (AltsÃ¥ at HA er slÃ¥et til)
      when: fg_ha.status == 200
      delegate_to: localhost
      ignore_errors: yes

    - name: "5c. Knyt Master til Virtual Chassis"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          virtual_chassis: "HA-{{ fw_site | default('SITE') }}"
          vc_position: 1
      when: fg_ha.status == 200
      delegate_to: localhost
      ignore_errors: yes

    - name: "5d. Opret den Passive FortiGate (Slave) i NetBox ðŸ›¡ï¸"
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # Vi kalder automatisk maskinen "Navn-Passive"
          name: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}-Passive"
          device_type: "FortiGate HA Cluster"
          device_role: "Firewall"
          site: "{{ fw_site | default(target_site) }}" 
          status: "active"
          virtual_chassis: "HA-{{ fw_site | default('SITE') }}"
          vc_position: 2
      when: fg_ha.status == 200
      delegate_to: localhost
      ignore_errors: yes

    - name: "6a. SYNC Fysiske & Aggregate Interfaces (ForÃ¦ldre) ðŸ”Œ"
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          name: "{{ item.name }}"
          # Type lag eller physical.
          type: "{{ 'lag' if item.type == 'aggregate' else '1000base-t' }}"
          enabled: "{{ item.status == 'up' }}"
          mac_address: "{{ item.macaddr | default(item.mac) | default(omit) }}"
          # Opret en lÃ¦kker description ud fra Alias
          description: "{{ item.alias | default('') }}"
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      # HER ER FIXET TIL "RÃ˜VFULD INTERFACES":
      when: 
        - item.name is defined
        - item.type in ['physical', 'aggregate']  # Kun rigtige kabler og LAGs!
      delegate_to: localhost
      ignore_errors: yes

    - name: "6b. SYNC VLAN Sub-interfaces (BÃ¸rnene) ðŸ‘¨â€ðŸ‘¦"
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
          name: "{{ item.name }}"
          type: "virtual"
          enabled: "{{ item.status == 'up' }}"
          parent_interface: "{{ item.interface | default(omit) }}"
          description: "{{ item.alias | default('') }}"
          # RETTET HER: Ansible-modulet kalder det bare 'mode'
          mode: "access"
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      when: 
        - item.name is defined
        - item.type == 'vlan'
        - item.interface is defined
        - item.interface != ''
      delegate_to: localhost
      ignore_errors: yes

    - name: "7. SYNC IP Adresser (Gateways) ðŸŒ"
      netbox.netbox.netbox_ip_address:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # RETTET HER: Vi splitter '192.168.1.1 255.255.255.0'. 
          # Vi tager IP'en (del 0). Hvis masken er 255.255.255.0 sÃ¦tter vi /24. Hvis 255.255.255.248 sÃ¦tter vi /29 osv.
          address: >-
            {{ 
               item.ip.split(' ')[0] ~ 
               (
                 '/24' if '255.255.255.0' in item.ip else 
                 '/29' if '255.255.255.248' in item.ip else
                 '/30' if '255.255.255.252' in item.ip else
                 '/32' if '255.255.255.255' in item.ip else
                 '/16' if '255.255.0.0' in item.ip else '/24'
               ) 
            }}
          status: "active"
          assigned_object:
            device: "{{ fg_status.json.results.hostname | default('FortiGate-Master') }}"
            name: "{{ item.name }}"
      loop: "{{ fg_interfaces_cmdb.json.results | default([]) }}"
      when: 
        - item.ip is defined
        - "'0.0.0.0' not in item.ip"
        - "item.ip != ''"
        - item.type in ['physical', 'aggregate', 'vlan']
      delegate_to: localhost
      ignore_errors: yes
