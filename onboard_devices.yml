---
# PLAY 1: Snyd Ansible og opret en midlertidig liste over de fundne IP'er
- name: Forbered de ukendte IP-adresser
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Tilføj fundne IP'er til midlertidig gruppe
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: discovered_routers
        ansible_connection: network_cli
        ansible_network_os: ios
        ansible_user: "{{ onboard_user }}"
        ansible_password: "{{ onboard_password }}"
      loop: "{{ target_ips.split(',') }}"
      when: target_ips is defined

# PLAY 2: Log ind på routerne og send dem til NetBox
- name: Brownfield Onboarding (Router -> NetBox)
  hosts: discovered_routers
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"

  tasks:
    - name: 1. Hent hardware facts direkte fra routeren
      cisco.ios.ios_facts:
        gather_subset: hardware

    - name: 2. Sikr at producenten 'Cisco' findes
      netbox.netbox.netbox_manufacturer:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "Cisco"
        state: present
      delegate_to: localhost
      run_once: true

    - name: 3. Sikr at rollen 'Router' findes
      netbox.netbox.netbox_device_role:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "Router"
          color: "00bcd4"
        state: present
      delegate_to: localhost
      run_once: true

    - name: 4. Opret Device Type (Hvis den mangler helt)
      netbox.netbox.netbox_device_type:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          manufacturer: "Cisco"
          # Vi tvinger modellen til store bogstaver her også!
          model: "{{ ansible_net_model | upper }}"
          slug: "{{ ansible_net_model | lower | replace(' ', '-') }}"
        state: present
      delegate_to: localhost

    - name: 5. Opret selve enheden i NetBox
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ ansible_net_hostname }}"
          # HER ER MAGIEN: Vi ændrer det til store bogstaver!
          device_type: "{{ ansible_net_model | upper }}"
          device_role: "Router"
          site: "{{ target_site }}"
          serial: "{{ ansible_net_serialnum }}"
          status: "active"
        state: present
      delegate_to: localhost
