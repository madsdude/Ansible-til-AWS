---
# PLAY 1: Forbered IP'er
- name: Forbered de ukendte IP-adresser
  hosts: localhost
  gather_facts: no
  tasks:
    - name: TilfÃ¸j fundne IP'er til midlertidig gruppe
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: discovered_routers
        ansible_connection: network_cli
        ansible_network_os: ios
        ansible_user: "{{ onboard_user }}"
        ansible_password: "{{ onboard_password }}"
      loop: "{{ target_ips.split(',') }}"
      when: target_ips is defined

# PLAY 2: Full Discovery (Hardware, Interfaces, IP, VLAN)
- name: Brownfield Onboarding (Full Discovery Mode)
  hosts: discovered_routers
  gather_facts: no

  vars:
    netbox_url: "{{ lookup('ansible.builtin.env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('ansible.builtin.env', 'NETBOX_TOKEN') }}"

  tasks:
    - name: 1. Hent ALLE informationer fra switchen (Kun lÃ¦s) ðŸ”
      cisco.ios.ios_facts:
        gather_subset: 
          - hardware
          - interfaces
          - config  # Vi henter config for at kunne lÃ¦se VLANs

    - name: 2. Sikr Basis-objekter i NetBox (Manufacturer, Role, Type)
      block:
        - netbox.netbox.netbox_manufacturer:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Cisco" }
        - netbox.netbox.netbox_device_role:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data: { name: "Router", color: "00bcd4" }
        - netbox.netbox.netbox_device_type:
            netbox_url: "{{ netbox_url }}"
            netbox_token: "{{ netbox_token }}"
            validate_certs: no
            data:
              manufacturer: "Cisco"
              model: "{{ ansible_net_model | upper }}"
              slug: "{{ ansible_net_model | lower | replace(' ', '-') }}"
      delegate_to: localhost
      run_once: true

    - name: 3. Opret/Opdater selve switchen
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ ansible_net_hostname }}"
          device_type: "{{ ansible_net_model | upper }}"
          device_role: "Router"
          site: "{{ target_site }}"
          serial: "{{ ansible_net_serialnum }}"
          status: "active"
        state: present
      delegate_to: localhost

    - name: 4. SYNC VLANs (LÃ¦s fra switch -> Skriv til NetBox) ðŸ·ï¸
      netbox.netbox.netbox_vlan:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          name: "{{ item.name }}"
          vid: "{{ item.vlan_id }}"
          site: "{{ target_site }}"
          status: "active"
        state: present
      loop: "{{ ansible_net_vlans | default([]) }}"
      delegate_to: localhost
      when: ansible_net_vlans is defined

    - name: 5. SYNC INTERFACES ðŸ”Œ
      netbox.netbox.netbox_device_interface:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          device: "{{ ansible_net_hostname }}"
          name: "{{ item.key }}"
          type: "1000base-t"
          enabled: "{{ item.value.enabled | default(true) }}"
          description: "{{ item.value.description | default('') }}"
          # Her kobler vi VLANet pÃ¥ porten hvis det er et Vlan-interface
          mode: "{{ 'access' if 'Vlan' not in item.key else '' }}"
        state: present
      loop: "{{ ansible_net_interfaces | dict2items }}"
      delegate_to: localhost

    - name: 6. SYNC IP-ADRESSER (Med Fix for Mask-fejl) ðŸŒ
      netbox.netbox.netbox_ip_address:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        validate_certs: no
        data:
          # FIX: Vi tjekker om mask findes, ellers bruger vi /32 som sikkerhed
          address: "{{ item.value.ipv4[0].address }}/{{ item.value.ipv4[0].mask | default('255.255.255.255') }}"
          status: "active"
          assigned_object:
            device: "{{ ansible_net_hostname }}"
            name: "{{ item.key }}"
        state: present
      loop: "{{ ansible_net_interfaces | dict2items }}"
      when: 
        - item.value.ipv4 is defined 
        - item.value.ipv4 | length > 0
      delegate_to: localhost
